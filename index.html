<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N1 CyberSphere - JLPT N1 2026/07</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Exo+2:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Exo 2', sans-serif;
            background-color: #0a0e17;
            color: #e0f7ff;
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(16, 64, 120, 0.15) 0%, transparent 20%),
                radial-gradient(circle at 80% 70%, rgba(0, 150, 200, 0.1) 0%, transparent 20%),
                linear-gradient(to bottom, #0a0e17, #0c1220);
        }
        
        .cyber-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 150, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 150, 255, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            z-index: -1;
            opacity: 0.4;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(0, 150, 255, 0.3);
            margin-bottom: 40px;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .logo-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #00a8ff, #0066cc);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            transform: rotate(45deg);
            box-shadow: 0 0 20px rgba(0, 168, 255, 0.5);
        }
        
        .logo-icon i {
            transform: rotate(-45deg);
        }
        
        .logo-text {
            font-family: 'Orbitron', sans-serif;
            font-weight: 900;
            font-size: 28px;
            background: linear-gradient(to right, #00a8ff, #00ffcc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 1px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 40, 80, 0.4);
            padding: 12px 20px;
            border-radius: 10px;
            border: 1px solid rgba(0, 150, 255, 0.3);
            backdrop-filter: blur(10px);
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff9900, #ff6600);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #000;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 18px;
        }
        
        .user-greeting {
            color: #88d3ff;
            font-size: 14px;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 40px;
        }
        
        .mission-panel {
            background: rgba(0, 20, 40, 0.6);
            border-radius: 15px;
            padding: 30px;
            border: 1px solid rgba(0, 150, 255, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        
        .mission-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #00a8ff, #00ffcc);
        }
        
        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            margin-bottom: 25px;
            color: #00e5ff;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title i {
            color: #ff9900;
        }
        
        .target-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .target-card {
            flex: 1;
            min-width: 250px;
            background: rgba(0, 30, 60, 0.5);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 150, 255, 0.2);
            position: relative;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .target-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 100, 255, 0.3);
        }
        
        .target-card::after {
            content: '';
            position: absolute;
            top: 10px;
            right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: radial-gradient(circle, #00ffcc, transparent);
            opacity: 0.7;
        }
        
        .card-title {
            font-size: 16px;
            color: #88d3ff;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: #00ffcc;
            text-shadow: 0 0 10px rgba(0, 255, 204, 0.5);
        }
        
        .card-value.special {
            color: #ff9900;
            text-shadow: 0 0 10px rgba(255, 153, 0, 0.5);
        }
        
        .card-subtitle {
            font-size: 14px;
            color: #a0c8e0;
            margin-top: 5px;
        }
        
        .streak-counter {
            background: rgba(0, 30, 60, 0.7);
            border-radius: 12px;
            padding: 25px;
            margin-top: 20px;
            border: 1px solid rgba(255, 153, 0, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .streak-counter::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 153, 0, 0.1) 50%, transparent 70%);
            animation: shine 3s infinite;
        }
        
        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .streak-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 20px;
            color: #ff9900;
            margin-bottom: 15px;
        }
        
        .streak-days {
            font-family: 'Orbitron', sans-serif;
            font-size: 42px;
            font-weight: 900;
            color: #ffcc00;
            text-shadow: 0 0 15px rgba(255, 204, 0, 0.7);
            margin-bottom: 5px;
        }
        
        .streak-text {
            font-size: 18px;
            color: #ffdd99;
        }
        
        .modules-section {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .module-card {
            background: rgba(0, 20, 40, 0.7);
            border-radius: 12px;
            padding: 25px;
            border: 1px solid rgba(0, 150, 255, 0.3);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .module-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 25px rgba(0, 100, 255, 0.4);
            border-color: #00a8ff;
        }
        
        .module-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(to right, #0066cc, #00a8ff);
        }
        
        .module-icon {
            width: 60px;
            height: 60px;
            background: rgba(0, 100, 200, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #00a8ff;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 150, 255, 0.3);
        }
        
        .module-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            margin-bottom: 10px;
            color: #00e5ff;
        }
        
        .module-desc {
            color: #a0c8e0;
            font-size: 15px;
            line-height: 1.5;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            height: 8px;
            background: rgba(0, 50, 100, 0.5);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #0066cc, #00ffcc);
            border-radius: 4px;
            width: 0%;
            transition: width 1.5s ease-out;
        }
        
        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: #88d3ff;
        }
        
        .start-button {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(to right, #0066cc, #00a8ff);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Orbitron', sans-serif;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            margin-top: 20px;
            letter-spacing: 1px;
        }
        
        .start-button:hover {
            background: linear-gradient(to right, #00a8ff, #00ffcc);
            box-shadow: 0 0 20px rgba(0, 168, 255, 0.7);
            transform: scale(1.02);
        }
        
        .floating-elements {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: -1;
        }
        
        .floating-element {
            position: absolute;
            background: rgba(0, 150, 255, 0.1);
            border: 1px solid rgba(0, 150, 255, 0.3);
            border-radius: 10px;
            animation: float 20s infinite linear;
        }
        
        .floating-element:nth-child(1) {
            width: 80px;
            height: 80px;
            top: 10%;
            left: 5%;
            animation-delay: 0s;
        }
        
        .floating-element:nth-child(2) {
            width: 60px;
            height: 60px;
            top: 20%;
            right: 10%;
            animation-delay: -5s;
        }
        
        .floating-element:nth-child(3) {
            width: 100px;
            height: 100px;
            bottom: 15%;
            left: 10%;
            animation-delay: -10s;
        }
        
        .floating-element:nth-child(4) {
            width: 70px;
            height: 70px;
            bottom: 25%;
            right: 5%;
            animation-delay: -15s;
        }
        
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(20px, 30px) rotate(90deg); }
            50% { transform: translate(0, 60px) rotate(180deg); }
            75% { transform: translate(-20px, 30px) rotate(270deg); }
            100% { transform: translate(0, 0) rotate(360deg); }
        }
        
        .cyber-line {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .cyber-line::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(to right, transparent, #00ffcc, transparent);
            animation: scan 4s linear infinite;
        }
        
        @keyframes scan {
            0% { top: 0%; }
            100% { top: 100%; }
        }
        
        .glow-effect {
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0, 150, 255, 0.1), transparent 70%);
            filter: blur(20px);
            z-index: -1;
        }
        
        .glow-1 {
            top: 10%;
            right: 10%;
        }
        
        .glow-2 {
            bottom: 10%;
            left: 10%;
        }
        
        footer {
            text-align: center;
            padding: 30px 0;
            margin-top: 50px;
            border-top: 1px solid rgba(0, 150, 255, 0.2);
            color: #88d3ff;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .target-info {
                flex-direction: column;
            }
            
            .target-card {
                min-width: 100%;
            }
            
            .modules-section {
                grid-template-columns: 1fr;
            }
            
            .logo-text {
                font-size: 22px;
            }
            
            .user-info {
                padding: 8px 15px;
            }
        }
        /* ===== LICENSE GATE ===== */
.license-gate {
  position: fixed;
  inset: 0;
  background: rgba(2, 8, 18, 0.88);
  backdrop-filter: blur(10px);
  z-index: 9999;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.license-panel {
  width: min(720px, 100%);
  background: rgba(0, 20, 40, 0.75);
  border: 1px solid rgba(0, 150, 255, 0.35);
  border-radius: 16px;
  box-shadow: 0 20px 60px rgba(0,0,0,0.6);
  padding: 24px;
  position: relative;
  overflow: hidden;
}

.license-panel::before{
  content:'';
  position:absolute; top:0; left:0; right:0; height:4px;
  background: linear-gradient(to right, #00a8ff, #00ffcc);
}

.license-row {
  display: grid;
  grid-template-columns: 1fr;
  gap: 14px;
  margin-top: 14px;
}

.license-input {
  width: 100%;
  padding: 14px 14px;
  border-radius: 10px;
  border: 1px solid rgba(0,150,255,0.35);
  background: rgba(0, 10, 25, 0.75);
  color: #e0f7ff;
  outline: none;
  font-size: 15px;
}

.license-actions {
  display:flex;
  gap: 12px;
  flex-wrap: wrap;
}

.license-btn {
  padding: 12px 14px;
  border-radius: 10px;
  border: 0;
  cursor:pointer;
  font-family: 'Orbitron', sans-serif;
  letter-spacing: 0.5px;
}

.license-btn.primary {
  background: linear-gradient(to right, #0066cc, #00a8ff);
  color: #fff;
}
.license-btn.primary:hover {
  background: linear-gradient(to right, #00a8ff, #00ffcc);
  box-shadow: 0 0 20px rgba(0,168,255,0.5);
}

.license-btn.ghost {
  background: rgba(0, 40, 80, 0.35);
  color: #88d3ff;
  border: 1px solid rgba(0,150,255,0.25);
}

.license-badge {
  display:inline-flex;
  gap:10px;
  align-items:center;
  padding: 10px 12px;
  border-radius: 12px;
  border: 1px solid rgba(255,153,0,0.35);
  background: rgba(40,20,0,0.25);
  color: #ffdd99;
  margin-top: 10px;
}

.license-small {
  color:#a0c8e0;
  font-size: 13px;
  line-height: 1.5;
}

.license-kv {
  display:grid;
  grid-template-columns: 160px 1fr;
  gap: 10px;
  padding: 12px;
  border: 1px solid rgba(0,150,255,0.2);
  border-radius: 12px;
  background: rgba(0, 30, 60, 0.35);
}

.license-kv code{
  word-break: break-all;
  color:#00ffcc;
}

.license-status {
  margin-top: 10px;
  font-size: 14px;
  color: #88d3ff;
}
.license-status.error { color: #ff8a8a; }
.license-status.ok { color: #00ffcc; }

    </style>
</head>
<body>
    <div class="cyber-grid"></div>
    <div class="cyber-line"></div>
    <div class="floating-elements">
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
        <div class="floating-element"></div>
    </div>
    <div class="glow-effect glow-1"></div>
    <div class="glow-effect glow-2"></div>
    <!-- ===== LICENSE GATE UI ===== -->
<div class="license-gate" id="licenseGate">
  <div class="license-panel">
    <h2 class="panel-title"><i class="fas fa-shield-halved"></i> K√çCH HO·∫†T B·∫¢N QUY·ªÄN</h2>

    <div class="license-small">
      Web c·ªßa b·∫°n ƒëang b·∫≠t ch·∫ø ƒë·ªô <b>Kh√≥a thi·∫øt b·ªã</b>: 1 m√°y / 1 license.<br/>
      Nh·∫≠p license ƒë·ªÉ m·ªü h·ªá th·ªëng.
    </div>

    <div class="license-row">
      <input class="license-input" id="licenseInput" placeholder="Nh·∫≠p license (VD: 20260701-xxxx...)" />

      <div class="license-actions">
        <button class="license-btn primary" id="btnActivate">
          <i class="fas fa-key"></i> K√çCH HO·∫†T
        </button>
        <button class="license-btn ghost" id="btnCopyDevice">
          <i class="fas fa-copy"></i> COPY THI·∫æT B·ªä HI·ªÜN T·∫†I
        </button>
        <button class="license-btn ghost" id="btnRequestReset">
          <i class="fas fa-rotate"></i> Y√äU C·∫¶U C·∫§P L·∫†I LICENSE
        </button>
      </div>

      <div class="license-status" id="licenseStatus">Tr·∫°ng th√°i: Ch∆∞a k√≠ch ho·∫°t</div>

      <div class="license-kv">
        <div>Thi·∫øt b·ªã hi·ªán t·∫°i</div>
        <div><code id="deviceIdText">...</code></div>

        <div>Th√¥ng tin</div>
        <div><code id="deviceInfoText">...</code></div>
      </div>

      <div class="license-small">
        <b>G·ª£i √Ω:</b> N·∫øu b·∫°n ƒë·ªïi m√°y / ƒë·ªïi tr√¨nh duy·ªát / x√≥a d·ªØ li·ªáu tr√¨nh duy·ªát ‚Üí deviceID thay ƒë·ªïi ‚Üí c·∫ßn c·∫•p l·∫°i license.
      </div>
    </div>
  </div>
</div>

<!-- B·ªçc app ƒë·ªÉ ·∫©n khi ch∆∞a c√≥ license -->
<div id="appRoot">
  <!-- GI·ªÆ NGUY√äN ph·∫ßn container c·ªßa b·∫°n ·ªü d∆∞·ªõi -->
</div>
<div id="appRoot">
    
    <div class="container">
        <header>
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-satellite"></i>
                </div>
                <div class="logo-text">N1 CYBERSPHERE</div>
            </div>
            <div class="user-info">
                <div class="user-avatar">T</div>
                <div>
                    <div class="user-greeting">Xin ch√†o</div>
                    <div class="user-name">Th·∫Øng üéâ</div>
                </div>
            </div>
        </header>
        
        <main class="main-content">
            <section class="mission-panel">
                <h2 class="panel-title"><i class="fas fa-bullseye"></i> M·ª§C TI√äU CHI·∫æN L∆Ø·ª¢C</h2>
                
                <div class="target-info">
                    <div class="target-card">
                        <div class="card-title"><i class="fas fa-flag"></i> M·ª•c ti√™u</div>
                        <div class="card-value">JLPT N1</div>
                        <div class="card-subtitle">C·∫•p ƒë·ªô cao nh·∫•t</div>
                    </div>
                    
                    <div class="target-card">
                        <div class="card-title"><i class="fas fa-calendar-alt"></i> Th·ªùi h·∫°n</div>
                        <div class="card-value special">07/2026</div>
                        <div class="card-subtitle">K·ª≥ thi th√°ng 7 nƒÉm 2026</div>
                    </div>
                    
                    <div class="target-card">
                        <div class="card-title"><i class="fas fa-rocket"></i> Tr·∫°ng th√°i</div>
                        <div class="card-value">ACTIVE</div>
                        <div class="card-subtitle">H·ªá th·ªëng ƒë√£ k√≠ch ho·∫°t</div>
                    </div>
                </div>
                
                <div class="streak-counter">
                    <div class="streak-title">
                        <i class="fas fa-fire"></i> CHU·ªñI HO·∫†T ƒê·ªòNG
                    </div>
                    <div class="streak-days">5 NG√ÄY</div>
                    <div class="streak-text">li√™n ti·∫øp ho√†n th√†nh nhi·ªám v·ª•!</div>
                </div>
            </section>
            
            <section class="mission-panel">
                <h2 class="panel-title"><i class="fas fa-cogs"></i> MODULE ƒê√ÄO T·∫†O</h2>
                
                <div class="modules-section">
                    <div class="module-card">
                        <div class="module-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <h3 class="module-title">T·ª™ V·ª∞NG N1</h3>
                        <p class="module-desc">H∆°n 2000 t·ª´ v·ª±ng n√¢ng cao v·ªõi h·ªá th·ªëng ghi nh·ªõ th√¥ng minh.</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-vocab"></div>
                        </div>
                        <div class="progress-text">
                            <span>Ti·∫øn ƒë·ªô</span>
                            <span id="percent-vocab">0%</span>
                        </div>
                    </div>
                    
                    <div class="module-card">
                        <div class="module-icon">
                            <i class="fas fa-language"></i>
                        </div>
                        <h3 class="module-title">NG·ªÆ PH√ÅP N1</h3>
                        <p class="module-desc">H∆°n 150 c·∫•u tr√∫c ng·ªØ ph√°p ph·ª©c t·∫°p v·ªõi gi·∫£i th√≠ch chi ti·∫øt.</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-grammar"></div>
                        </div>
                        <div class="progress-text">
                            <span>Ti·∫øn ƒë·ªô</span>
                            <span id="percent-grammar">0%</span>
                        </div>
                    </div>
                    
                    <div class="module-card">
                        <div class="module-icon">
                            <i class="fas fa-headphones"></i>
                        </div>
                        <h3 class="module-title">NGHE HI·ªÇU</h3>
                        <p class="module-desc">Luy·ªán nghe v·ªõi c√°c t√¨nh hu·ªëng th·ª±c t·∫ø v√† t·ªëc ƒë·ªô b·∫£n ng·ªØ.</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-listening"></div>
                        </div>
                        <div class="progress-text">
                            <span>Ti·∫øn ƒë·ªô</span>
                            <span id="percent-listening">0%</span>
                        </div>
                    </div>
                    
                    <div class="module-card">
                        <div class="module-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <h3 class="module-title">ƒê·ªåC HI·ªÇU</h3>
                        <p class="module-desc">Ph√¢n t√≠ch vƒÉn b·∫£n h·ªçc thu·∫≠t, b√°o ch√≠ v√† t√†i li·ªáu chuy√™n ng√†nh.</p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-reading"></div>
                        </div>
                        <div class="progress-text">
                            <span>Ti·∫øn ƒë·ªô</span>
                            <span id="percent-reading">0%</span>
                        </div>
                    </div>
                </div>
                
                <a href="#" class="start-button">
                    <i class="fas fa-play-circle"></i> KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG H·ªåC T·∫¨P
                </a>
            </section>
        </main>
        
        <footer>
            <p>¬© 2025 N1 CYBERSPHERE - H·ªá th·ªëng ƒë√†o t·∫°o JLPT N1 c√¥ng ngh·ªá cao</p>
            <p>Phi√™n b·∫£n 2.0 | Ch·∫ø ƒë·ªô: Dark Mode | K·∫øt n·ªëi: Stable</p>
        </footer>
    </div>
    </div>
    
    <script>
/**
 * ====== CONFIG ======
 * B·∫ÆT BU·ªòC: c√≥ server ƒë·ªÉ verify, v√¨ secret kh√¥ng ƒë∆∞·ª£c n·∫±m trong client.
 * B·∫°n ƒë·ªïi API_URL theo server c·ªßa b·∫°n.
 */


const API_URL = "https://n1-license-server.onrender.com/api/ping";




const LS_DEVICE_ID = "n1_device_id";
const LS_LICENSE = "n1_license";

/** ====== Utils ====== */
function uuidv4() {
  // UUID ƒë∆°n gi·∫£n ƒë·ªß d√πng
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
    const r = Math.random() * 16 | 0;
    const v = c === "x" ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

function getOrCreateDeviceId() {
  let id = localStorage.getItem(LS_DEVICE_ID);
  if (!id) {
    id = uuidv4();
    localStorage.setItem(LS_DEVICE_ID, id);
  }
  return id;
}

function getDeviceInfo() {
  const ua = navigator.userAgent || "";
  const lang = navigator.language || "";
  const platform = navigator.platform || "";
  return `${platform} | ${lang} | ${ua.slice(0, 80)}...`;
}

function setStatus(text, type="") {
  const el = document.getElementById("licenseStatus");
  el.textContent = text;
  el.classList.remove("error","ok");
  if (type) el.classList.add(type);
}

async function copyText(text) {
  try {
    await navigator.clipboard.writeText(text);
    return true;
  } catch {
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
    return true;
  }
}

/** ====== API ======
 * server s·∫Ω verify license + bind 1 license v√†o 1 device
 */
async function verifyLicense(deviceId, license) {
  const res = await fetch(`${API_URL}/verify`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ deviceId, license })
  });
  if (!res.ok) {
    const t = await res.text();
    throw new Error(t || "Verify failed");
  }
  return res.json(); // { ok: true, expiry: "20260701", bound: true }
}

async function requestReset(deviceId, oldLicense, note) {
  const res = await fetch(`${API_URL}/request-reset`, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ deviceId, oldLicense, note })
  });
  // request-reset c√≥ th·ªÉ ch·ªâ log mail/slack, n√™n ok/kh√¥ng ok t√πy b·∫°n
  if (!res.ok) {
    const t = await res.text();
    throw new Error(t || "Request reset failed");
  }
  return res.json();
}

/** ====== Gate flow ====== */
function showGate(show=true) {
  const gate = document.getElementById("licenseGate");
  const app = document.getElementById("appRoot");
  gate.style.display = show ? "flex" : "none";
  app.style.display = show ? "none" : "block";
}

function fillDeviceUI(deviceId) {
  document.getElementById("deviceIdText").textContent = deviceId;
  document.getElementById("deviceInfoText").textContent = getDeviceInfo();
}

function runAppUI() {
  // === code UI c≈© c·ªßa b·∫°n (progress + effects) ===
  document.addEventListener('DOMContentLoaded', function() {
      const progressData = { vocab: 65, grammar: 42, listening: 28, reading: 35 };

      for (const [module, value] of Object.entries(progressData)) {
          const progressFill = document.getElementById(`progress-${module}`);
          const percentText = document.getElementById(`percent-${module}`);

          progressFill.style.width = '0%';
          percentText.textContent = '0%';

          setTimeout(() => {
              progressFill.style.width = `${value}%`;
              percentText.textContent = `${value}%`;
          }, 300);
      }

      const startButton = document.querySelector('.start-button');
      startButton.addEventListener('click', function(e) {
          e.preventDefault();

          const ripple = document.createElement('div');
          ripple.style.position = 'fixed';
          ripple.style.borderRadius = '50%';
          ripple.style.backgroundColor = 'rgba(0, 168, 255, 0.6)';
          ripple.style.width = '10px';
          ripple.style.height = '10px';
          ripple.style.left = `${e.clientX}px`;
          ripple.style.top = `${e.clientY}px`;
          ripple.style.transform = 'translate(-50%, -50%)';
          ripple.style.zIndex = '1000';
          ripple.style.pointerEvents = 'none';
          document.body.appendChild(ripple);

          const animation = ripple.animate([
              { width: '10px', height: '10px', opacity: 1 },
              { width: '200px', height: '200px', opacity: 0 }
          ], { duration: 800, easing: 'ease-out' });

          animation.onfinish = () => ripple.remove();

          setTimeout(() => {
              alert("H·ªá th·ªëng h·ªçc t·∫≠p N1 ƒëang kh·ªüi ƒë·ªông...\nChu·∫©n b·ªã cho nhi·ªám v·ª• ng√†y h√¥m nay!");
          }, 300);
      });

      const targetCards = document.querySelectorAll('.target-card');
      targetCards.forEach(card => {
          card.addEventListener('mouseenter', () => {
              const afterElement = card.querySelector('.card-value');
              if (afterElement) afterElement.style.textShadow = '0 0 20px rgba(0, 255, 204, 0.8)';
          });

          card.addEventListener('mouseleave', () => {
              const afterElement = card.querySelector('.card-value');
              if (afterElement) afterElement.style.textShadow = '0 0 10px rgba(0, 255, 204, 0.5)';
          });
      });

      const streakDays = document.querySelector('.streak-days');
      let count = 0;
      const targetCount = 5;
      const countInterval = setInterval(() => {
          count++;
          streakDays.textContent = `${count} NG√ÄY`;
          if (count === targetCount) clearInterval(countInterval);
      }, 200);
  });
}

/** ====== Boot ====== */
(async function boot() {
  const deviceId = getOrCreateDeviceId();
  fillDeviceUI(deviceId);

  const savedLicense = localStorage.getItem(LS_LICENSE);
  const licenseInput = document.getElementById("licenseInput");
  if (savedLicense) licenseInput.value = savedLicense;

  // m·∫∑c ƒë·ªãnh: ch∆∞a ok => show gate
  showGate(true);

  // th·ª≠ auto verify n·∫øu c√≥ savedLicense
  if (savedLicense) {
    setStatus("ƒêang ki·ªÉm tra license...", "");
    try {
      const r = await verifyLicense(deviceId, savedLicense);
      if (r && r.ok) {
        setStatus(`K√≠ch ho·∫°t OK (h·∫°n: ${r.expiry})`, "ok");
        showGate(false);
        runAppUI();
        return;
      }
      setStatus("License kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n", "error");
    } catch (e) {
      setStatus("Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c license (server l·ªói ho·∫∑c sai API_URL)", "error");
    }
  }

  // Buttons
  document.getElementById("btnCopyDevice").addEventListener("click", async () => {
    await copyText(deviceId);
    setStatus("ƒê√£ copy deviceID. G·ª≠i deviceID n√†y ƒë·ªÉ c·∫•p license.", "ok");
  });

  document.getElementById("btnActivate").addEventListener("click", async () => {
    const license = licenseInput.value.trim();
    if (!license) return setStatus("B·∫°n ch∆∞a nh·∫≠p license", "error");

    setStatus("ƒêang k√≠ch ho·∫°t...", "");
    try {
      const r = await verifyLicense(deviceId, license);
      if (r && r.ok) {
        localStorage.setItem(LS_LICENSE, license);
        setStatus(`K√≠ch ho·∫°t OK (h·∫°n: ${r.expiry})`, "ok");
        showGate(false);
        runAppUI();
      } else {
        setStatus("License kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n", "error");
      }
    } catch (e) {
      setStatus("K√≠ch ho·∫°t th·∫•t b·∫°i: " + (e.message || "unknown"), "error");
    }
  });

  document.getElementById("btnRequestReset").addEventListener("click", async () => {
    const oldLicense = licenseInput.value.trim() || localStorage.getItem(LS_LICENSE) || "";
    const note = prompt("Nh·∫≠p l√Ω do c·∫•p l·∫°i (vd: ƒë·ªïi m√°y / c√†i l·∫°i Windows / x√≥a tr√¨nh duy·ªát):") || "";

    // T·∫°o m√£ y√™u c·∫ßu (copy ƒë∆∞·ª£c)
    const requestCode = `RESET|deviceId=${deviceId}|oldLicense=${oldLicense}|note=${note}`;
    await copyText(requestCode);

    setStatus("ƒê√£ copy m√£ y√™u c·∫ßu c·∫•p l·∫°i. D√°n m√£ n√†y g·ª≠i cho b·∫°n qu·∫£n tr·ªã.", "ok");

    // N·∫øu b·∫°n c√≥ endpoint server th√¨ g·ªçi th√™m (kh√¥ng c√≥ c≈©ng kh√¥ng sao)
    try {
      await requestReset(deviceId, oldLicense, note);
    } catch {}
  });

})();
</script>

</body>
</html>